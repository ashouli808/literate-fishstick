<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>UHF RFID Asset Scans</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .badge { background: #e8f0fe; color: #1967d2; padding: 4px 8px; border-radius: 4px; font-family: monospace; }
        #status { font-style: italic; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>UHF RFID Asset Scans</h1>
        <div class="controls">
            <select id="deviceSelect"><option value="">All Vehicles</option></select>
            <input type="date" id="fromDate">
            <button id="refreshBtn" style="background:#004a99; color:white; border:none; padding:8px 15px; cursor:pointer;">Update</button>
        </div>
        <div id="status">Ready</div>
        <table id="scanTable" style="display:none;">
            <thead>
                <tr><th>Timestamp</th><th>Vehicle</th><th>Tag ID</th></tr>
            </thead>
            <tbody id="scanBody"></tbody>
        </table>
    </div>

    <script>
        // Use a strictly scoped function to avoid eval triggers
        geotab.addin.rfidViewer = function() {
            var apiRef;
            var devices = {};

            // Internal function for fetching data
            var runSearch = function() {
                var status = document.getElementById('status');
                var body = document.getElementById('scanBody');
                var table = document.getElementById('scanTable');
                var devId = document.getElementById('deviceSelect').value;
                var dateVal = document.getElementById('fromDate').value;

                status.innerText = "Searching...";
                
                var searchObj = { 
                    diagnosticSearch: { id: "DiagnosticTextFromSerialId" }, 
                    resultsLimit: 100 
                };
                
                if (devId) searchObj.deviceSearch = { id: devId };
                if (dateVal) searchObj.fromDate = new Date(dateVal).toISOString();

                apiRef.call("Get", {
                    typeName: "StatusData",
                    search: searchObj
                }, function(results) {
                    status.style.display = 'none';
                    table.style.display = 'table';
                    body.innerHTML = "";

                    if (!results || results.length === 0) {
                        status.innerText = "No scans found in database.";
                        status.style.display = 'block';
                        table.style.display = 'none';
                        return;
                    }

                    results.forEach(function(scan) {
                        var row = body.insertRow();
                        row.insertCell(0).innerText = new Date(scan.dateTime).toLocaleString();
                        row.insertCell(1).innerText = devices[scan.device.id] || scan.device.id;
                        row.insertCell(2).innerHTML = '<span class="badge">' + scan.data + '</span>';
                    });
                }, function(err) {
                    status.innerText = "Error: " + err;
                });
            };

            return {
                initialize: function(api, state, callback) {
                    apiRef = api;
                    document.getElementById('fromDate').valueAsDate = new Date();
                    
                    api.call("Get", { typeName: "Device" }, function(result) {
                        var select = document.getElementById('deviceSelect');
                        result.forEach(function(d) {
                            devices[d.id] = d.name;
                            var opt = document.createElement('option');
                            opt.value = d.id;
                            opt.innerHTML = d.name;
                            select.appendChild(opt);
                        });
                        callback();
                    }, function(err) { callback(); });

                    document.getElementById('refreshBtn').addEventListener('click', runSearch);
                },
                focus: function(api, state) {
                    runSearch();
                },
                blur: function(api, state) {}
            };
        };
    </script>
</body>
</html>

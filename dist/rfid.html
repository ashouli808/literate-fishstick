<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RFID Scan Viewer</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        th { background-color: #2c3e50; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .loading { font-style: italic; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Recent RFID Scans</h1>
        <div id="status" class="loading">Fetching scan data...</div>
        <table id="scanTable" style="display:none;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Device</th>
                    <th>RFID Tag ID</th>
                </tr>
            </thead>
            <tbody id="scanBody"></tbody>
        </table>
    </div>

    <script>
        // The global geotab object provides the API access
        geotab.addin.rfidViewer = () => {
            return {
                initialize(api, state, callback) {
                    callback();
                },
                focus(api, state) {
                    const statusEl = document.getElementById('status');
                    const tableEl = document.getElementById('scanTable');
                    const bodyEl = document.getElementById('scanBody');

                    // Search for RFID status data (DiagnosticDriverIdReportedId)
                    api.call("Get", {
                        typeName: "StatusData",
                        search: {
                            diagnosticSearch: { id: "DiagnosticDriverIdReportedId" },
                            resultsLimit: 20 // Show last 20 scans
                        }
                    }, function(results) {
                        statusEl.style.display = 'none';
                        tableEl.style.display = 'table';
                        bodyEl.innerHTML = "";

                        if (results.length === 0) {
                            statusEl.innerText = "No scans found.";
                            statusEl.style.display = 'block';
                            return;
                        }

                        results.forEach(scan => {
                            const row = bodyEl.insertRow();
                            row.insertCell(0).innerText = new Date(scan.dateTime).toLocaleString();
                            row.insertCell(1).innerText = scan.device.id;
                            row.insertCell(2).innerText = scan.data; // The scanned ID
                        });
                    }, function(error) {
                        statusEl.innerText = "Error: " + error;
                    });
                },
                blur(api, state) {
                    // Cleanup if needed
                }
            };
        };
    </script>
</body>
</html>
